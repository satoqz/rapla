name: Build and push docker image

on:
  push:
    # TODO: remove rewrite before merge
    branches: [main, rewrite]

  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  # TODO: change to 'latest' before merge
  TAG: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:rewrite

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Nix
      uses: cachix/install-nix-action@v18

    - name: Setup Cachix
      uses: cachix/cachix-action@v12
      with:
        name: systems
        authToken: ${{ secrets.CACHIX_TOKEN }}

    - name: Check flake
      run: nix flake check

    - name: Build docker image
      run: nix build .#rapla-to-ics-docker

    - name: Load docker image
      run: docker load <result

    - name: Login to container registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Tag image
      run: docker tag rapla-to-ics:latest ${{ env.TAG }}

    - name: Push docker image
      run: docker push ${{ env.TAG }}
